<!DOCTYPE html>  <html> <head>   <title>forever.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               forever.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * forever.js: Top level include for the forever module</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2010 and Charlie Robbins</span>
<span class="cm"> * MIT LICENCE</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">),</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">colors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">),</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">),</span>
    <span class="nx">exec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">,</span>
    <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">,</span>
    <span class="nx">daemon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;daemon&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">forever</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">config</span><span class="p">;</span>

<span class="nx">forever</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>function load (options, [callback])
  Initializes configuration for forever module</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">();</span>
  <span class="nx">options</span>         <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">root</span>    <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">root</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;forever&#39;</span><span class="p">),</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">pidPath</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pidPath</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="s1">&#39;pids&#39;</span><span class="p">);</span>
  <span class="nx">forever</span><span class="p">.</span><span class="nx">config</span>  <span class="o">=</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create the two directories, ignoring errors</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="mi">0755</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">,</span> <span class="mi">0755</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err2</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">emitter</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>function stat (logFile, script, callback)
  Ensures that the logFile doesn't exist and that
  the target script does exist before executing callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">stat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">logFile</span><span class="p">,</span> <span class="nx">script</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">logFile</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;log file &#39;</span> <span class="o">+</span> <span class="nx">logFile</span> <span class="o">+</span> <span class="s1">&#39; exists.&#39;</span><span class="p">));</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;script &#39;</span> <span class="o">+</span> <span class="nx">script</span> <span class="o">+</span> <span class="s1">&#39; does not exist.&#39;</span><span class="p">));</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>function start (file, options) 
  Starts a script with forever
  [file]:    Location of the node script to run.
  [options]: Configuration for forever instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Forever</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">start</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>function startDaemon (file, options)
  Starts a script with forever as a daemon
  [file]:    Location of the node script to run.
  [options]: Configuration for forever instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">startDaemon</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">logFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logFile</span> <span class="o">||</span> <span class="s1">&#39;forever.log&#39;</span><span class="p">);</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">pidFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">runner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Forever</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  
  <span class="nx">fs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">logFile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pid</span> <span class="o">=</span> <span class="nx">daemon</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">fd</span><span class="p">);</span>
      <span class="nx">daemon</span><span class="p">.</span><span class="nx">lock</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">pid</span> <span class="o">=</span> <span class="nx">pid</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Remark: This should work, but the fd gets screwed up 
        with the daemon process.</p>

<p>process.on('exit', function () {
  fs.unlinkSync(options.pidFile);
});</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="nx">runner</span><span class="p">.</span><span class="nx">start</span><span class="p">().</span><span class="nx">save</span><span class="p">().</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fvr</span><span class="p">)</span> <span class="p">{</span> <span class="nx">fvr</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">runner</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>function stop (target, [format])
  Stops the process with the specified index or
  script name in the list of all processes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">(),</span>
      <span class="nx">processes</span> <span class="o">=</span> <span class="nx">getAllProcesses</span><span class="p">(),</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
  
  <span class="kd">var</span> <span class="nx">procs</span> <span class="o">=</span> <span class="sr">/(\d+)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">?</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">findByIndex</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">processes</span><span class="p">)</span>
                                   <span class="o">:</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">findByScript</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">processes</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">procs</span> <span class="o">&amp;&amp;</span> <span class="nx">procs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">procs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">kill</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">foreverPid</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">kill</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">pid</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="nx">format</span> <span class="o">?</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">procs</span><span class="p">)</span> <span class="o">:</span> <span class="nx">procs</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot find forever process: &#39;</span> <span class="o">+</span> <span class="nx">target</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">emitter</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>function findByIndex (index, processes)
  Finds the process with the specified index.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">findByIndex</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">processes</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="nx">processes</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">index</span><span class="p">)]];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>function findByScript (script, processes)
  Finds the process with the specified script name.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">findByScript</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">file</span> <span class="o">===</span> <span class="nx">script</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>function stopAll (format) 
  Stops all forever processes
  [format]: Value indicating if we should format output</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">stopAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">(),</span>
      <span class="nx">processes</span> <span class="o">=</span> <span class="nx">getAllProcesses</span><span class="p">()</span> <span class="o">||</span> <span class="p">[],</span>
      <span class="nx">pids</span> <span class="o">=</span> <span class="nx">getAllPids</span><span class="p">(</span><span class="nx">processes</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">processes</span> <span class="o">=</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">processes</span><span class="p">);</span>
  <span class="p">}</span>    
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">pids</span> <span class="o">&amp;&amp;</span> <span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fPids</span> <span class="o">=</span> <span class="nx">pids</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">pid</span><span class="p">.</span><span class="nx">foreverPid</span> <span class="p">}),</span>
        <span class="nx">cPids</span> <span class="o">=</span> <span class="nx">pids</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">pid</span><span class="p">.</span><span class="nx">pid</span> <span class="p">});</span>
    
    <span class="nx">fPids</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">cPids</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">kill</span><span class="p">(</span><span class="nx">pid</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stopAll&#39;</span><span class="p">,</span> <span class="nx">processes</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stopAll&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">emitter</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>function list (format) 
  Returns the list of all process data managed by forever.
  [format]: If set, will return a formatted string of data</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">procs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">formatted</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">procs</span> <span class="o">=</span> <span class="nx">procs</span> <span class="o">||</span> <span class="nx">getAllProcesses</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">procs</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">maxLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Iterate over the procs to see which has the longest options string</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">procs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">proc</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="p">[</span><span class="nx">proc</span><span class="p">.</span><span class="nx">file</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">options</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxLen</span><span class="p">)</span> <span class="nx">maxLen</span> <span class="o">=</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span>
    
    <span class="nx">procs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create padding string to keep output aligned</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">padding</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">maxLen</span> <span class="o">-</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="nx">formatted</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">formatProcess</span><span class="p">(</span><span class="nx">proc</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">padding</span><span class="p">));</span>
      <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">format</span> <span class="o">?</span> <span class="nx">formatted</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">procs</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>function cleanUp () 
  Utility function for removing excess pid and 
  config files used by forever.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">cleanUp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cleanLogs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">(),</span>
      <span class="nx">processes</span> <span class="o">=</span> <span class="nx">getAllProcesses</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">cleanLogs</span><span class="p">)</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">cleanLogsSync</span><span class="p">(</span><span class="nx">processes</span><span class="p">);</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="nx">processes</span> <span class="o">&amp;&amp;</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">checked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">processes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">checkProcess</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">checkProcess</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">foreverPid</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">manager</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">child</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">manager</span> <span class="o">||</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">dead</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Ignore errors</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="p">});</span>
            <span class="p">}</span>
            
            <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">,</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">foreverPid</span> <span class="o">+</span> <span class="s1">&#39;.fvr&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Ignore errors</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">});</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">cleanLogs</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">logFile</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="cm">/* Ignore Errors */</span> <span class="p">});</span>
            <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="nx">checked</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">checked</span> <span class="o">===</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;cleanUp&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;cleanUp&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">emitter</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>function cleanLogsSync (processes)
  Removes all log files from the root forever directory
  that do not belong to current running forever processes.
  [processes]: The set of all forever processes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">cleanLogsSync</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">root</span><span class="p">),</span>
      <span class="nx">runningLogs</span> <span class="o">=</span> <span class="nx">processes</span> <span class="o">&amp;&amp;</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">logFile</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span> <span class="p">});</span>
  
  <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/\.log$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">runningLogs</span> <span class="o">||</span> <span class="nx">runningLogs</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">file</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>function randomString (bits)
  randomString returns a pseude-random ASCII string which contains at least 
  the specified number of bits of entropy the return value is a string of 
  length ⌈bits/6⌉ of characters from the base64 alphabet.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">randomString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">chars</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#39;</span><span class="p">,</span> 
      <span class="nx">rand</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>in v8, Math.random() yields 32 pseudo-random bits (in spidermonkey it gives 53)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">while</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rand</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mh">0x100000000</span><span class="p">)</span> <span class="c1">// 32-bit integer</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>base 64 means 6 bits per character, so we use the top 30 bits from rand to give 30/6=5 characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">26</span><span class="p">;</span> <span class="nx">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">bits</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">-=</span><span class="mi">6</span><span class="p">,</span> <span class="nx">bits</span><span class="o">-=</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">ret</span><span class="o">+=</span><span class="nx">chars</span><span class="p">[</span><span class="mh">0x3F</span> <span class="o">&amp;</span> <span class="nx">rand</span> <span class="o">&gt;&gt;&gt;</span> <span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>function checkProcess (pid, callback) 
  Utility function to check to see if a pid is running</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">checkProcess</span> <span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;ps &#39;</span> <span class="o">+</span> <span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39; | grep -v PID&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>function formatProcess (index, padding) 
  Returns a formatted string for the process (proc) at
  the specified index. 
  [proc]:    Process to format
  [index]:   Index of the process in the set of all processes
  [padding]: Padding to add to the formatted output </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">formatProcess</span> <span class="p">(</span><span class="nx">proc</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">padding</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create an array of the output we can later join</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;  [&#39;</span> <span class="o">+</span> <span class="nx">index</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">green</span><span class="p">]</span>
    <span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">green</span> <span class="p">}))</span>
    <span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">padding</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">foreverPid</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">logFile</span><span class="p">.</span><span class="nx">magenta</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>function getAllProcess ([findDead])
  Returns all data for processes managed by forever
  [findDead]: Optional parameter that indicates to return dead procs</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">getAllProcesses</span> <span class="p">(</span><span class="nx">findDead</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">processes</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">files</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  
  <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fullPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">),</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.(\w{3})$/</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;pid&#39;</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">pid</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">processes</span><span class="p">[</span><span class="nx">pid</span><span class="p">])</span> <span class="nx">processes</span><span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foreverPid</span><span class="o">:</span> <span class="nx">pid</span> <span class="p">};</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="s1">&#39;fvr&#39;</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
          <span class="nx">processes</span><span class="p">[</span><span class="nx">child</span><span class="p">.</span><span class="nx">foreverPid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Ignore errors </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">processes</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">processes</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">findDead</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">processes</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">pid</span><span class="p">)</span> <span class="nx">processes</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">dead</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">processes</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>function getAllPids ()
  Returns the set of all pids managed by forever. 
  e.x. [{ pid: 12345, foreverPid: 12346 }, ...]</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">getAllPids</span> <span class="p">(</span><span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">processes</span> <span class="o">=</span> <span class="nx">processes</span> <span class="o">||</span> <span class="nx">getAllProcesses</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">processes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">pid</span><span class="o">:</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span>
        <span class="nx">foreverPid</span><span class="o">:</span> <span class="nx">proc</span><span class="p">.</span><span class="nx">foreverPid</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Forever (file, options)
  Creates a new instance of forever with specified params.
  [file]:    Location of the node script to run.
  [options]: Configuration for this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Forever</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">silent</span>  <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">forever</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forever</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">command</span> <span class="o">||</span> <span class="s1">&#39;node&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">options</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">max</span>     <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">max</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">logFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logFile</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pidFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">outFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">outFile</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">errFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">errFile</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">childExists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="nx">file</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>If we should log stdout, open a file buffer </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stdout</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flags</span><span class="o">:</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="mi">0666</span> <span class="p">});</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If we should log stderr, open a file buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stderr</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flags</span><span class="o">:</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="mi">0666</span> <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Inherit from events.EventEmitter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">sys</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Forever</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>function start () 
  Start the process that this instance is configured for</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Forever</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">restart</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">restart</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot start process that is already running.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trySpawn</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Target script does not exist: &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">restart</span> <span class="o">?</span> <span class="s1">&#39;restart&#39;</span> <span class="o">:</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Hook all stream data and process it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">listenTo</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">child</span><span class="p">[</span><span class="nx">stream</span><span class="p">].</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">silent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>If we haven't been silenced, and we don't have a file stream
to output to write to the process stdout stream</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>If we have been given an output file for the stream, write to it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">].</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Listen to stdout and stderr</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">listenTo</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">);</span>
  <span class="nx">listenTo</span><span class="p">(</span><span class="s1">&#39;stderr&#39;</span><span class="p">);</span>
    
  <span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Forever detected script exited with code: &#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">times</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">forever</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">times</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Forever restarting script for &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">times</span> <span class="o">+</span> <span class="s1">&#39; time&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If had to write to an stdout file, close it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If had to write to an stderr file, close it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">stderr</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>function trySpawn() 
  Tries to spawn the target Forever child process. Depending on
  configuration, it checks the first argument of the options
  to see if the file exists. This is useful is you are
  trying to execute a script with an env: e.g. node myfile.js</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Forever</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trySpawn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">===</span> <span class="s1">&#39;node&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkFile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">childExists</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childExists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">spawn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>function save ()
  Persists this instance of forever to disk.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Forever</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot save Forever instance that is not running&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">childData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">pid</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span>
    <span class="nx">foreverPid</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span>
    <span class="nx">logFile</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFile</span><span class="p">,</span>
    <span class="nx">options</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">file</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="p">};</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">childData</span> <span class="o">=</span> <span class="nx">childData</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">)</span> <span class="nx">childData</span><span class="p">.</span><span class="nx">pidFile</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pidFile</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">)</span> <span class="nx">childData</span><span class="p">.</span><span class="nx">outFile</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">)</span> <span class="nx">childData</span><span class="p">.</span><span class="nx">errFile</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">;</span>
  
  <span class="kd">var</span> <span class="nx">childPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pidPath</span><span class="p">,</span> <span class="nx">childData</span><span class="p">.</span><span class="nx">foreverPid</span> <span class="o">+</span> <span class="s1">&#39;.fvr&#39;</span><span class="p">);</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">childPath</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">childData</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="nx">childPath</span><span class="p">,</span> <span class="nx">childData</span><span class="p">);</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Setup the forever process to listen to 
SIGINT and SIGTERM events so that we can
clean up the *.pid file</p>

<p>Remark: This should work, but the fd gets screwed up 
        with the daemon process.</p>

<p>process.on('SIGINT', function () {
  process.exit(0);
});</p>

<p>process.on('SIGTERM', function () {
  process.exit(0);
});
process.on('exit', function () {
  fs.unlinkSync(childPath);
});</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>function log (message)
  Utility function for logging forever actions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Forever</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sys</span><span class="p">.</span><span class="nx">puts</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>function stop ()
  Stops this instance of forever</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Forever</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot stop process that is not running.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">childData</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Export the Forever object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">forever</span><span class="p">.</span><span class="nx">Forever</span> <span class="o">=</span> <span class="nx">Forever</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 